name: Deploy Azure Functions

on:
  workflow_dispatch:
  push:
    branches: [ main ]

concurrency:
  group: deploy-aspayr-worker
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev
    env:
      AZURE_FUNCTIONAPP_NAME: ${{ vars.AZURE_FUNCTIONAPP_NAME }}
      AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Azure Login (OIDC)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Sync app settings
        env:
          YAPILY_APPLICATION_UUID: ${{ secrets.YAPILY_APPLICATION_UUID }}
          YAPILY_APPLICATION_SECRET: ${{ secrets.YAPILY_APPLICATION_SECRET }}
          YAPILY_BASE_URL: ${{ vars.YAPILY_BASE_URL || 'https://api.yapily.com' }}
          COSMOS_ENDPOINT: ${{ vars.COSMOS_ENDPOINT }}
          COSMOS_KEY: ${{ secrets.COSMOS_KEY }}
          COSMOS_DATABASE_ID: ${{ vars.COSMOS_DATABASE_ID || 'fin' }}
          TRANSACTIONS_CONTAINER_ID: ${{ vars.TRANSACTIONS_CONTAINER_ID || 'Transactions' }}
          CONSENTS_CONTAINER_ID: ${{ vars.CONSENTS_CONTAINER_ID || 'Consents' }}
          SYNC_TRANSACTIONS_CRON: ${{ vars.SYNC_TRANSACTIONS_CRON || '0 0 */6 * * *' }}
          SYNC_LOOKBACK_DAYS: ${{ vars.SYNC_LOOKBACK_DAYS || '30' }}
        run: |
          az functionapp config appsettings set \
            --name "$AZURE_FUNCTIONAPP_NAME" \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --settings \
              "YAPILY_APPLICATION_UUID=$YAPILY_APPLICATION_UUID" \
              "YAPILY_APPLICATION_SECRET=$YAPILY_APPLICATION_SECRET" \
              "YAPILY_BASE_URL=$YAPILY_BASE_URL" \
              "COSMOS_ENDPOINT=$COSMOS_ENDPOINT" \
              "COSMOS_KEY=$COSMOS_KEY" \
              "COSMOS_DATABASE_ID=$COSMOS_DATABASE_ID" \
              "TRANSACTIONS_CONTAINER_ID=$TRANSACTIONS_CONTAINER_ID" \
              "CONSENTS_CONTAINER_ID=$CONSENTS_CONTAINER_ID" \
              "SYNC_TRANSACTIONS_CRON=$SYNC_TRANSACTIONS_CRON" \
              "SYNC_LOOKBACK_DAYS=$SYNC_LOOKBACK_DAYS"

      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run build

      - name: Deploy to Azure Functions
        uses: azure/functions-action@v1
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
          package: dist

      - name: Logout
        if: always()
        run: az logout
